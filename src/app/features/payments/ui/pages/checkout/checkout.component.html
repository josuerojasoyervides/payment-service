<!-- Header -->
<div class="header">
    <h1>Checkout</h1>
    <p class="subtitle">Sistema de pagos con arquitectura empresarial</p>
</div>

<!-- Resumen de Orden -->
<div class="order-summary">
    <h4>Resumen de Orden</h4>
    <div class="order-line">
        <span>Order ID</span>
        <span><code>{{ orderId() }}</code></span>
    </div>
    <div class="order-line">
        <span>Subtotal</span>
        <span>{{ amount() | currency: currency() }}</span>
    </div>
    <div class="order-line">
        <span>Total a pagar</span>
        <span>{{ amount() | currency: currency() }}</span>
    </div>
</div>

<!-- Paso 1: Seleccionar Provider -->
<section>
    <h3>
        <span class="step-number">1</span>
        Proveedor de pago
    </h3>
    <div class="provider-buttons">
        @for (provider of availableProviders(); track provider) {
            <button 
                class="provider-btn"
                [class.active]="selectedProvider() === provider"
                [disabled]="isLoading()"
                (click)="selectProvider(provider)">
                {{ provider | titlecase }}
            </button>
        }
    </div>
</section>

<!-- Paso 2: Seleccionar M√©todo -->
<section>
    <h3>
        <span class="step-number">2</span>
        M√©todo de pago
    </h3>
    
    @if (availableMethods().length === 0) {
        <p style="color: #dc3545;">No hay m√©todos disponibles para {{ selectedProvider() }}</p>
    } @else {
        <div class="method-buttons">
            @for (method of availableMethods(); track method) {
                <button 
                    class="method-btn"
                    [class.active]="selectedMethod() === method"
                    [disabled]="isLoading()"
                    (click)="selectMethod(method)">
                    @switch (method) {
                        @case ('card') { üí≥ Tarjeta }
                        @case ('spei') { üè¶ SPEI }
                        @default { {{ method | titlecase }} }
                    }
                </button>
            }
        </div>
    }
</section>

<!-- Paso 3: Formulario Din√°mico -->
@if (fieldRequirements(); as requirements) {
    <section>
        <h3>
            <span class="step-number">3</span>
            Datos de pago
        </h3>
        
        @if (requirements.description) {
            <p class="form-description">{{ requirements.description }}</p>
        }
        
        @if (requirements.instructions) {
            <div class="form-instructions">
                üí° {{ requirements.instructions }}
            </div>
        }
        
        <form [formGroup]="paymentForm">
            @for (field of requirements.fields; track field.name) {
                @if (isFieldVisible(field)) {
                    <div class="field">
                        <label>
                            {{ field.label }}
                            @if (field.required) {
                                <span class="required">*</span>
                            }
                        </label>
                        <input 
                            [type]="getFieldType(field)"
                            [formControlName]="field.name"
                            [placeholder]="field.placeholder ?? ''" />
                    </div>
                } @else {
                    <div class="field hidden-field">
                        <strong>{{ field.label }}:</strong> 
                        <code>{{ paymentForm.get(field.name)?.value || '(auto)' }}</code>
                        <span style="color: #666; margin-left: 8px;">(autom√°tico)</span>
                    </div>
                }
            }
        </form>
        
        @if (requirements.fields.length === 0) {
            <p style="color: #666;">Este m√©todo no requiere datos adicionales.</p>
        }
    </section>
}

<!-- Bot√≥n de Pago -->
<button 
    class="pay-button"
    [disabled]="isLoading()"
    (click)="processPayment()">
    @if (isLoading()) {
        <span class="spinner">‚è≥</span> Procesando...
    } @else {
        üí≥ Pagar {{ amount() | currency: currency() }} con {{ selectedProvider() | titlecase }}
    }
</button>

<!-- Error -->
@if (hasError() && currentError(); as error) {
    <div class="result error">
        <div class="result-header">
            ‚ùå Error en el pago
        </div>
        <p>{{ $any(error).message || 'Ha ocurrido un error procesando el pago' }}</p>
        
        <details>
            <summary>Ver detalles t√©cnicos</summary>
            <pre>{{ error | json }}</pre>
        </details>
        
        <button 
            style="margin-top: 12px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;"
            (click)="resetPayment()">
            Intentar de nuevo
        </button>
    </div>
}

<!-- Resultado exitoso -->
@if (isReady() && currentIntent(); as intent) {
    <div class="result success">
        <div class="result-header">
            ‚úÖ Pago iniciado correctamente
        </div>
        
        <dl class="intent-details">
            <dt>Intent ID</dt>
            <dd><code>{{ intent.id }}</code></dd>
            
            <dt>Provider</dt>
            <dd>{{ intent.provider | titlecase }}</dd>
            
            <dt>Estado</dt>
            <dd>
                <span class="status-badge" [class]="getStatusClass(intent.status)">
                    {{ intent.status }}
                </span>
            </dd>
            
            <dt>Monto</dt>
            <dd>{{ intent.amount | currency: intent.currency }}</dd>
        </dl>

        <!-- Next Action -->
        @if (intent.nextAction; as nextAction) {
            <div class="next-action-card">
                <h4>‚ö†Ô∏è Acci√≥n requerida: {{ nextAction.type }}</h4>
                
                @switch (nextAction.type) {
                    @case ('3ds') {
                        <div class="threeds-info">
                            <p>Tu banco requiere verificaci√≥n adicional (3D Secure).</p>
                            <p>Ser√°s redirigido a una p√°gina segura para completar la autenticaci√≥n.</p>
                        </div>
                    }
                    
                    @case ('spei') {
                        <div class="spei-details">
                            <p><strong>CLABE:</strong> {{ $any(nextAction).clabe }}</p>
                            <p><strong>Referencia:</strong> {{ $any(nextAction).reference }}</p>
                            <p><strong>Banco:</strong> {{ $any(nextAction).bank }}</p>
                            <p><strong>Beneficiario:</strong> {{ $any(nextAction).beneficiary }}</p>
                            <p><strong>Monto:</strong> {{ $any(nextAction).amount | currency: $any(nextAction).currency }}</p>
                            <p><strong>Expira:</strong> {{ $any(nextAction).expiresAt | date:'medium' }}</p>
                        </div>
                    }
                    
                    @case ('paypal_approve') {
                        <div class="paypal-info">
                            <p>Ser√°s redirigido a PayPal para aprobar el pago.</p>
                            <p>
                                <a [href]="$any(nextAction).approveUrl" target="_blank">
                                    Ir a PayPal ‚Üí
                                </a>
                            </p>
                        </div>
                    }
                    
                    @default {
                        <p>Tipo de acci√≥n: {{ nextAction.type }}</p>
                    }
                }
            </div>
        }

        <details style="margin-top: 16px;">
            <summary style="cursor: pointer; color: #666;">Ver respuesta completa</summary>
            <pre>{{ intent | json }}</pre>
        </details>
        
        <button 
            style="margin-top: 16px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;"
            (click)="resetPayment()">
            Nuevo pago
        </button>
    </div>
}

<!-- Modal de Fallback -->
@if (hasPendingFallback() && pendingFallbackEvent(); as event) {
    <div class="fallback-modal-overlay">
        <div class="fallback-modal">
            <h3>‚ö†Ô∏è Problema con el pago</h3>
            <p>
                {{ event.failedProvider | titlecase }} no est√° disponible en este momento.
                ¬øDeseas intentar con otro proveedor?
            </p>
            
            <div class="fallback-options">
                @for (provider of event.alternativeProviders; track provider) {
                    <button 
                        [class.selected]="selectedFallbackProvider() === provider"
                        (click)="selectFallbackProvider(provider)">
                        {{ provider | titlecase }}
                    </button>
                }
            </div>
            
            <div class="fallback-actions">
                <button class="cancel-btn" (click)="cancelFallback()">
                    Cancelar
                </button>
                <button 
                    class="retry-btn" 
                    [disabled]="!selectedFallbackProvider()"
                    (click)="confirmFallback()">
                    Reintentar con {{ selectedFallbackProvider() || '...' | titlecase }}
                </button>
            </div>
        </div>
    </div>
}

<!-- Debug Section -->
<div class="debug-section">
    <h3>üîç Debug Info</h3>
    
    <details>
        <summary>Estado del Store</summary>
        <pre>{{ debugInfo() | json }}</pre>
    </details>
    
    <details>
        <summary>Field Requirements</summary>
        <pre>{{ fieldRequirements() | json }}</pre>
    </details>
    
    <details>
        <summary>Formulario actual</summary>
        <pre>{{ paymentForm.value | json }}</pre>
    </details>
</div>

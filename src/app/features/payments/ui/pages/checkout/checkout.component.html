<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Checkout</h1>
            <p class="text-gray-600 mt-2">Sistema de pagos con arquitectura empresarial</p>
            
            <!-- Navigation -->
            <div class="flex justify-center gap-4 mt-4 text-sm">
                <a routerLink="/payments/history" class="text-blue-600 hover:underline">
                    Ver historial
                </a>
                <a routerLink="/payments/status" class="text-blue-600 hover:underline">
                    Consultar estado
                </a>
                <a routerLink="/payments/showcase" class="text-blue-600 hover:underline">
                    Showcase
                </a>
            </div>
        </div>

        <!-- Mostrar resultado si hay √©xito o error -->
        @if (showResult()) {
            <div class="mb-6">
                <app-payment-result
                    [intent]="currentIntent()"
                    [error]="currentError()"
                    (retry)="resetPayment()"
                    (newPayment)="resetPayment()"
                />

                <!-- Next Action si existe -->
                @if (currentIntent()?.nextAction) {
                    <app-next-action-card
                        [nextAction]="currentIntent()!.nextAction!"
                    />
                }
            </div>
        } @else {
            <!-- Flujo de checkout -->
            <div class="space-y-6">
                <!-- Order Summary -->
                <app-order-summary
                    [orderId]="orderId()"
                    [amount]="amount()"
                    [currency]="currency()"
                />

                <!-- Step 1: Provider Selection -->
                <div class="card">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="step-number">1</span>
                        <h2 class="text-lg font-semibold">Proveedor de pago</h2>
                    </div>
                    <app-provider-selector
                        [providers]="availableProviders()"
                        [selected]="selectedProvider()"
                        [disabled]="isLoading()"
                        (providerChange)="selectProvider($event)"
                    />
                </div>

                <!-- Step 2: Method Selection -->
                <div class="card">
                    <div class="flex items-center gap-3 mb-4">
                        <span [class]="selectedProvider() ? 'step-number' : 'step-number-inactive'">2</span>
                        <h2 class="text-lg font-semibold">M√©todo de pago</h2>
                    </div>
                    <app-method-selector
                        [methods]="availableMethods()"
                        [selected]="selectedMethod()"
                        [disabled]="isLoading() || !selectedProvider()"
                        (methodChange)="selectMethod($event)"
                    />
                </div>

                <!-- Step 3: Payment Form -->
                @if (selectedMethod()) {
                    <div class="card">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="step-number">3</span>
                            <h2 class="text-lg font-semibold">Datos de pago</h2>
                        </div>
                        <app-payment-form
                            [requirements]="fieldRequirements()"
                            [disabled]="isLoading()"
                            (formChange)="onFormChange($event)"
                            (formValidChange)="onFormValidChange($event)"
                        />
                    </div>
                }

                <!-- Payment Button -->
                @if (selectedProvider() && selectedMethod()) {
                    <app-payment-button
                        [amount]="amount()"
                        [currency]="currency()"
                        [provider]="selectedProvider()"
                        [loading]="isLoading()"
                        [disabled]="!isFormValid()"
                        (pay)="processPayment()"
                    />
                }
            </div>
        }

        <!-- Debug Section (solo en desarrollo) -->
        @if (isDevMode) {
            <div class="mt-8 p-4 bg-gray-100 rounded-lg">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-600 font-medium">
                        üîç Debug Info
                    </summary>
                    <div class="mt-4 space-y-2 text-xs font-mono">
                        <p><strong>Provider:</strong> {{ selectedProvider() }}</p>
                        <p><strong>Method:</strong> {{ selectedMethod() }}</p>
                        <p><strong>Form Valid:</strong> {{ isFormValid() }}</p>
                        <p><strong>Loading:</strong> {{ isLoading() }}</p>
                        <pre class="bg-white p-2 rounded mt-2 overflow-auto">{{ debugInfo() | json }}</pre>
                    </div>
                </details>
            </div>
        }

        <!-- Fallback Modal -->
        <app-fallback-modal
            [event]="pendingFallbackEvent()"
            [open]="hasPendingFallback()"
            (confirm)="confirmFallback($event)"
            (cancel)="cancelFallback()"
        />
    </div>
</div>
